<!DOCTYPE html>
<html>
  <head>
    <title>Komatsu Simulator Gateway</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      body {
        font-family: "Segoe UI", sans-serif;
        background: #0f172a;
        color: white;
        padding: 2rem;
      }
      .grid {
        display: grid;
        grid-template-columns: 1fr 2fr;
        gap: 2rem;
      }
      .card {
        background: #1e293b;
        padding: 1.5rem;
        border-radius: 12px;
        border: 1px solid #334155;
        box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
      }

      button {
        display: block;
        width: 100%;
        padding: 15px;
        margin-bottom: 10px;
        font-weight: bold;
        font-size: 1rem;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s;
      }
      button:hover {
        filter: brightness(110%);
        transform: translateY(-1px);
      }

      .btn-crit {
        background: linear-gradient(to right, #ef4444, #b91c1c);
        color: white;
        box-shadow: 0 0 15px rgba(239, 68, 68, 0.4);
      }
      .btn-norm {
        background: linear-gradient(to right, #3b82f6, #2563eb);
        color: white;
      }
      .btn-stop {
        background: #64748b;
        color: white;
      }

      h1 {
        margin-bottom: 2rem;
        color: #e2e8f0;
        border-bottom: 1px solid #334155;
        padding-bottom: 1rem;
      }
      h2 {
        margin-top: 0;
        color: #94a3b8;
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
      }

      .metric-row {
        display: flex;
        justify-content: space-between;
        margin-bottom: 20px;
      }
      .metric-box {
        text-align: center;
        background: #0f172a;
        padding: 1rem;
        border-radius: 8px;
        border: 1px solid #334155;
        width: 30%;
      }
      .metric-val {
        font-size: 1.8rem;
        font-family: monospace;
        font-weight: bold;
        color: #38bdf8;
      }
      .metric-label {
        font-size: 0.8rem;
        color: #64748b;
      }

      #status-badge {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 999px;
        background: #334155;
        font-size: 0.8rem;
      }
    </style>
  </head>
  <body>
    <h1>Kinetic Capacitor Guardian - Simulator Gateway</h1>

    <div class="grid">
      <div class="card">
        <h2>Operations Control</h2>
        <div style="margin-bottom: 20px">
          <span id="status-badge">SYSTEM: NORMAL</span>
        </div>

        <button class="btn-norm" onclick="setMode('NORMAL')">
          ðŸŸ¢ START / NORMAL OPS
        </button>
        <button class="btn-stop" onclick="setMode('STOPPED')">
          âšª STOP MOCK
        </button>

        <hr style="border: 0; border-top: 1px solid #334155; margin: 20px 0" />

        <h2>Fault Injection</h2>
        <button class="btn-crit" onclick="setMode('CRITICAL')">
          ðŸ”¥ INJECT FAULT: THERMAL RUNAWAY
        </button>
        <p style="font-size: 0.8rem; color: #64748b; text-align: center">
          Triggers: High ESR (>2.0Î©), High Temp (>85Â°C), Smoke Image
        </p>
      </div>

      <div class="card">
        <h2>Real-time Telemetry Stream</h2>

        <div class="metric-row">
          <div class="metric-box">
            <div class="metric-val" id="temp">--</div>
            <div class="metric-label">CORE TEMP (Â°C)</div>
          </div>
          <div class="metric-box">
            <div class="metric-val" id="risk">--</div>
            <div class="metric-label">RISK SCORE</div>
          </div>
          <div class="metric-box">
            <div class="metric-val" id="torque">--</div>
            <div class="metric-label">TORQUE LIMIT (%)</div>
          </div>
        </div>

        <canvas id="tempChart" height="120"></canvas>
      </div>
    </div>

    <script>
      const ctx = document.getElementById("tempChart").getContext("2d");
      const chart = new Chart(ctx, {
        type: "line",
        data: {
          labels: [],
          datasets: [
            {
              label: "Core Temperature (Â°C)",
              data: [],
              borderColor: "#38bdf8",
              backgroundColor: "rgba(56, 189, 248, 0.1)",
              borderWidth: 2,
              fill: true,
              tension: 0.4,
            },
          ],
        },
        options: {
          animation: false,
          scales: {
            y: { beginAtZero: false, grid: { color: "#334155" } },
            x: { display: false },
          },
          plugins: { legend: { display: false } },
        },
      });

      async function setMode(mode) {
        await fetch(`/api/control/${mode}`, { method: "POST" });
        // Update badge immediately for UX
        const badge = document.getElementById("status-badge");
        badge.innerText = `SYSTEM: ${mode}`;
        badge.style.background = mode === "CRITICAL" ? "#ef4444" : "#334155";
      }

      // Poll Loop
      setInterval(async () => {
        try {
          const res = await fetch("/api/telemetry/snapshot");
          const data = await res.json();

          document.getElementById("temp").innerText = data.core_temp.toFixed(1);
          document.getElementById("risk").innerText =
            (data.trrs_score * 100).toFixed(0) + "%";
          document.getElementById("torque").innerText = data.torque_limit;

          // Update Chart
          const now = new Date().toLocaleTimeString();
          if (chart.data.labels.length > 20) {
            chart.data.labels.shift();
            chart.data.datasets[0].data.shift();
          }
          chart.data.labels.push(now);
          chart.data.datasets[0].data.push(data.core_temp);
          chart.update();
        } catch (e) {
          console.log("Polling error...");
        }
      }, 1000);
    </script>
  </body>
</html>
